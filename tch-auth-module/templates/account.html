<div id="account" v-cloak>
  <!-- <pre>
    {{$store.state.user}}
  </pre>
  <pre>
    {{getReaded}}
  </pre> -->
  <n-config-provider :locale="locale.ruRU" :date-locale="locale.dateRuRU" :theme-overrides="theme">
    <div class="account_content" v-if="!$store.state.loading">
      <div class="left_menu">
        <n-menu 
          :options="menuOptions" 
          v-model:value="currentOption"
          @update:value="updateOption"></n-menu>
      </div>
      <div class="main_content">
        <n-alert
          :title="getUserSubscribeAccess?.title"
          :type="getUserSubscribeAccess.type"
          v-if="!$store.state.loading && currentOption === 'profile'"
          :style="{marginBottom: '25px'}">
          <div v-html="getUserSubscribeAccess.text"></div>
        </n-alert>
        
        <template v-if="currentOption === 'profile'">
          
          <n-form>
            <n-form-item
              v-for="(item, index) in profileData"
              size="large"
              :label="item[1].label">
              <n-input :value="item[1].value" :disabled="!item[1].editable" :class="{'pointer-none': item[1].editable}">
                <template #prefix>
                  <i :class="item[1].icon"></i>
                </template>

                <template #suffix v-if="item[1].editable">
                  <n-button 
                    @click="editPorfileDate(item[0], item[1].value)"
                    quaternary 
                    type="info" 
                    size="small" 
                    icon-placement="left" 
                    round>
                    –ò–∑–º–µ–Ω–∏—Ç—å
                    <template #icon>
                      <i class="ph ph-pencil-simple"></i>
                    </template>
                  </n-button>
                </template>
              </n-input>

              <template #feedback v-if="!item[1].editable">
                –î–æ—Å—Ç—É–ø –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∏–º–µ–µ—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–∞–π—Ç–∞
              </template>
            </n-form-item>
          </n-form>

        </template>
        <template v-if="currentOption === 'security'">
          <n-form class="security">
            <n-form-item 
              label="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å"
              size="large"
              :feedback="securityDataFeedbacks.old_password.text" 
              :validation-status="securityDataFeedbacks.old_password.status">
              
              <n-input 
                type="password"
                show-password-on="click"
                v-model:value="securityData.old_password"
                placeholder="">
                <template #prefix>
                  <i class="ph ph-lock-open"></i>
                </template>
              </n-input>
            </n-form-item>

            <n-form-item 
              label="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"
              size="large"
              :feedback="securityDataFeedbacks.new_password.text" 
              :validation-status="securityDataFeedbacks.new_password.status">
              
              <n-input 
                type="password"
                show-password-on="click"
                v-model:value="securityData.new_password"
                placeholder="">
                <template #prefix>
                  <i class="ph ph-lock"></i>
                </template>
              </n-input>
            </n-form-item>

            <n-form-item 
              label="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"
              size="large"
              :feedback="securityDataFeedbacks.new_password_repeat.text" 
              :validation-status="securityDataFeedbacks.new_password_repeat.status">
              
              <n-input 
                type="password"
                show-password-on="click"
                v-model:value="securityData.new_password_repeat"
                placeholder="">
                <template #prefix>
                  <i class="ph ph-lock"></i>
                </template>
              </n-input>
            </n-form-item>

            <n-button 
              size="large" 
              type="info" 
              @click="onChangePassword"
              :loading="securityData.loading">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</n-button>
          </n-form>
        </template>
        <template v-if="currentOption === 'news'">
          <n-list v-for="(group, index) in notificationsPosts" clickable hoverable>
            <template #header>
              {{group.label}}
            </template>
            <n-list-item v-for="post in group.subposts" @click="openPost(post.link)">
              <template #suffix>
                {{showTime(post.datetime)}}
              </template>
              <n-thing :title="post.name">
              </n-thing>
            </n-list-item>
            <div :style="{height: '25px'}" v-if="index != (notificationsPosts.length - 1)"></div>
          </n-list>
        </template>
        <template v-if="currentOption === 'favorites'">
          <n-alert
            title="–°—Ç–∞—Ç—å–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"
            type="info"
            v-if="$store.state.user.favArticles.length == 0">
            –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Å—Ç–∞—Ç—å–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.
          </n-alert>
          <n-list clickable hoverable v-else>
            <n-list-item v-for="(post, index) in $store.state.user.favArticles" >
              <template #suffix>
                <n-button quaternary circle type="error" @click="onRemoveFromFav(post.id)"> 
                  <template #icon>
                    <i class="ph ph-trash" v-if="!post.loading"></i>
                    <img v-else src="/wp-content/plugins/tch-auth-module/res/loading.svg" alt="" width="18" height="18">
                  </template>
                </n-button>
              </template>
              <n-thing :title="post.title" :description="post.parent" @click="openPost(post.link)">
              </n-thing>
            </n-list-item>
            <div :style="{height: '25px'}" v-if="index != ($store.state.user.favArticles.length - 1)"></div>
          </n-list>
        </template>
      </div>
    </div>
    <div class="account_content" v-else>
      <div class="left_menu">
        <n-space vertical>
          <n-skeleton height="42px" width="100%" :sharp="false" v-for="n in 5" />
        </n-space>
      </div>
      <div class="main_content">
        <div :style="{marginBottom: '25px'}">
          <n-skeleton height="70px" width="100%" :sharp="false"  />
        </div>
        <n-space vertical>
          <n-skeleton 
            :height="n % 2 ? '25px' : '40px'" 
            :width="n % 2 ? '75px' : '100%'" 
            :sharp="false" 
            :round="n % 2 ? true : false"
            v-for="n in 8" />
        </n-space>
      </div>

      
    </div>

    <n-modal v-model:show="welcomeModal" :mask-closable="false">
      <n-card
        style="width: 600px"
        :bordered="false"
        size="huge"
        role="dialog"
        aria-modal="true"
        class="welcome"
      >
        <template #header-extra>
          <n-button quaternary circle @click="welcomeModal = false">
            <template #icon>
              <n-icon><i class="ph ph-x"></i></n-icon>
            </template>
          </n-button>
        </template>
        <n-space justify="center">
          <img src="/wp-content/plugins/tch-auth-module/res/logo.png" :style="{width: '150px', marginBottom: '25px'}">
        </n-space>
        <p :style="{textAlign:'center'}">–ú—ã –¥–∞—Ä–∏–º –í–∞–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∂—É—Ä–Ω–∞–ª—É "–ê–ë-–≠–∫—Å–ø—Ä–µ—Å—Åü•≥ <br/>
        –î–æ—Å—Ç—É–ø –±—É–¥–µ—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ 1 –¥–µ–Ω—å! –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∂—É—Ä–Ω–∞–ª–∞ –¥–ª—è –í–∞—Å –¥–æ—Å—Ç—É–ø–Ω—ã!</p>

        <div id="surprise"></div>

        <template #footer>
          <n-space justify="center">
            <n-button type="info" quaternary @click="closeWelcomeModal">–ó–∞–∫—Ä—ã—Ç—å</n-button>
          </n-space>
        </template>
      </n-card>
    </n-modal>

    <n-modal v-model:show="userEditModal">
      <n-card
        style="width: 400px"
        :bordered="false"
        size="medium"
        role="dialog"
        aria-modal="true"
      >
        <template #header>
          –ò–∑–º–µ–Ω–∏—Ç—å {{userEditData.label}}
        </template>
        <template #header-extra>
          <n-button quaternary circle @click="closeUserEditModal">
            <template #icon>
              <n-icon><i class="ph ph-x"></i></n-icon>
            </template>
          </n-button>
        </template>
        <n-alert
          v-if="userEditData.response.visible"
          :type="userEditData.response.type"
          :style="{marginBottom: '25px'}">
          <div v-html="userEditData.response.text"></div>
        </n-alert>
        <n-form>
          <n-form-item
            size="large"
            :label="userEditData.label">
            <n-input 
              v-if="userEditData.field != 'phone'" 
              v-model:value="userEditData.value">
            </n-input>
            <n-input 
              v-else
              @input="onEnterPhone"
              :value="userEditData.value">
            </n-input>
          </n-form-item>
        </n-form>
        <template #footer>
          <n-space justify="center">
            <n-button 
              type="info" 
              size="large" 
              :loading="userEditData.loading"
              @click="saveEditedProfile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</n-button>
          </n-space>
        </template>
      </n-card>
    </n-modal>
  </n-config-provider>
</div>

<script>
  document.addEventListener("DOMContentLoaded", (event) => {
    dayjs.locale('ru')
    const path = window.location.pathname;
    const { h } = window.Vue;

    const App = {
      data: () => ({
        locale: {
          ruRU: naive.ruRU,
          dateRuRU: naive.dateRuRU
        },
        theme: {
          common: {
            borderRadius: '8px',
            infoColor: '#006ab4'
          }
        },
        welcomeModal: false,
        userEditModal: false,
        userEditData: {},
        currentOption: 'profile',
        menuOptions: [
          {
            label: '–ü—Ä–æ—Ñ–∏–ª—å',
            key: 'profile',
            icon() {
              return h('i', { class: 'ph ph-user' })
            },
          },
          {
            label: '–õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π',
            key: 'news',
            icon() {
              return h('i', { class: 'ph ph-newspaper' })
            },
          },
          {
            label: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ',
            key: 'favorites',
            icon() {
              return h('i', { class: 'ph ph-heart' })
            },
          },
          {
            label: '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å',
            key: 'security',
            icon() {
              return h('i', { class: 'ph ph-shield' })
            },
          },
          {
            type: 'divider',
            key: 'd1'
          },
          {
            label: '–í—ã–π—Ç–∏',
            key: 'logout',
            icon() {
              return h('i', { class: 'ph ph-sign-out' })
            },
          }
        ],
        profileData: {},
        securityData: {
          loading: false,
          validated: false,
          old_password: '',
          new_password: '',
          new_password_repeat: ''
        },
        securityDataFeedbacks: {
          old_password: {
            text: '',
            status: null
          },
          new_password: {
            text: '',
            status: null
          },
          new_password_repeat: {
            text: '',
            status: null
          },
        },
        notificationsPosts: [],
        notificationsCleared: false
        
      }),
      created() {
        this.getNotificationPosts();
        const searchParams = new URLSearchParams(window.location.search);
        if (searchParams.has('updated')) {
          toastifyPush('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
        }
      },
      watch: {
        '$store.state.user' : function(val) {
          this.userDataFormat(val);
          this.showWelcome(val);
          const searchParams = new URLSearchParams(window.location.search);
          if (searchParams.has('tab')) {
            this.currentOption = searchParams.get('tab')
          } 
        },
        '$store.state.tabname': function(val) {
          this.currentOption = val;
          this.$store.state.tabname = val;
        },
        currentOption(val) {
          if(val === 'news') {
            this.clearNotifications();
          }
        },
        userEditModal(val) {
          if(!val) this.closeUserEditModal()
        }
      },
      computed: {
        getUserSubscribeAccess() {
          if(this.$store.state.user.access === true) {
            return {
              type: 'info',
              text: `–ü–æ–¥–ø–∏—Å–∫–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ ${this.$store.state.user.subscribe_end} –≥–æ–¥–∞.`
            }
          }

          if (this.$store.state.user.access === false) {
            return {
              type: 'error',
              title: '–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞',
              text: `–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –±—ã–ª–∞ –∑–∞–∫–æ–Ω—á–µ–Ω–∞ ${this.$store.state.user.subscribe_end}. –°–≤—è–∂–∏—Ç–µ—Å—å —Å —Ä–µ–¥–∞–∫—Ü–∏–µ–π –∂—É—Ä–Ω–∞–ª–∞ –∏–ª–∏ <a href="/podpiska-na-zhurnal/">–ø—Ä–æ–¥–ª–∏—Ç–µ</a> –ø–æ–¥–ø–∏—Å–∫—É –æ–Ω–ª–∞–π–Ω.`
            }
          }

          return
        },
        getReaded() {
          return Cookies.get('readed')
        }
        
      },
      methods: {
        async onValidatePassword() {
          const data = this.securityData;

          if(data.old_password.length == 0) {
            this.securityDataFeedbacks.old_password = {
              text: '–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å',
              status: 'error'
            }
            this.securityData.validated = false
          } else {
            this.securityDataFeedbacks.old_password = {
              text: '',
              status: null
            }
            this.securityData.validated = true
          }

          if (data.new_password.length == 0) {
            this.securityDataFeedbacks.new_password = {
              text: '–ù–∞–ø–∏—à–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å',
              status: 'error'
            }
            this.securityData.validated = false
          } else {
            if(data.new_password.length < 6) {
              this.securityDataFeedbacks.new_password = {
                text: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ 6 —Å–∏–º–≤–æ–ª–æ–≤',
                status: 'error'
              }
              this.securityData.validated = false
            } else {
              this.securityDataFeedbacks.new_password = {
                text: '',
                status: null
              }
              this.securityData.validated = true
            }
          }

          if(data.new_password_repeat.length == 0) {
            this.securityDataFeedbacks.new_password_repeat = {
              text: '–ù–∞–ø–∏—à–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –ø–æ–≤—Ç–æ—Ä–Ω–æ',
              status: 'error'
            }
            this.securityData.validated = false
          } else {
            if(data.new_password_repeat != data.new_password) {
              this.securityDataFeedbacks.new_password_repeat = {
                text: '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç',
                status: 'error'
              }
              this.securityData.validated = false
            } else {
              this.securityDataFeedbacks.new_password_repeat = {
                text: '',
                status: null
              }
            }
          }
        },
        async onChangePassword() {
          await this.onValidatePassword();
          const valid = Object.entries(this.securityDataFeedbacks).filter(el => el[1].text != '');
          if (valid.length > 0) return;
          try {
            this.securityData.loading = true;
            const res = await req.post('user/password', this.securityData);
            this.clearSecurity();
            this.securityData.loading = false;
            toastifyPush('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
          } catch (error) {
            this.securityData.loading = false;
            if(error.response.status == 401) {
              this.securityDataFeedbacks.old_password = {
                text: error.response.data?.error,
                status: 'error'
              }
            } else {
              toastifyPush('–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞', 'error')
            }
          }
        },
        async getNotificationPosts() {
          try {
            const res = await req.get('notify');
            const posts = res.data;
            const groups = posts.reduce((groups, post) => {
              const date = post.date;
              if (!groups[date]) {
                groups[date] = [];
              }
              groups[date].push(post);
              return groups;
            }, {});

            // Edit: to add it in the array format instead
            const groupArrays = Object.keys(groups).map((date) => {
              return {
                date,
                label: this.compareDates(date),
                subposts: groups[date]
              };
            });
            this.notificationsPosts = groupArrays
          } catch (error) {
            console.log(error);
          }
        },
        async clearNotifications() {
          const loaded = await !this.$store.state.loading;

          Cookies.set('readed', this.$store.state.user.notifications);
        },
        async onValidateEditProfile() {
          const data = this.userEditData;
          if (data.field == 'email') {
            if (data.value.length == 0) {
              toastifyPush('–ü—É—Å—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –ø–æ—á—Ç—ã', 'error')
              return false;
            }
            if (!validateEmail(data.value)) {
              toastifyPush('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–æ—á—Ç–∞', 'error')
              return false;
            }
          }
          if (data.field == 'phone') {
            if (data.value.length == 0) {
              toastifyPush('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω', 'error')
              return false;
            }
            if (data.value.length != 18) {
              toastifyPush('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ç–µ–ª–µ—Ñ–æ–Ω', 'error')
              return false;
            }
          }

          return true
        },
        async saveEditedProfile() {
          const validated = await this.onValidateEditProfile();
          if(!validated) return;

          this.userEditData.loading = true;
          try {
            const res = await req.post('user/edit', this.userEditData);
            
            if(res.data == 'updated') {
              this.userEditData.response = {
                type: 'success',
                visible: true,
                text: '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã'
              }
              this.$store.commit('getUser');
              this.userEditData.loading = false;

              setTimeout(() => { this.closeUserEditModal() }, 2000);
            } else {
              this.userEditData.response = {
                type: 'success',
                visible: true,
                text: '–ù–∞ –≤–∞—à—É —Ç–µ–∫—É—â—É—é –ø–æ—á—Ç—É –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–∏—Å—å–º–æ, –ø—Ä–æ—Å–∏–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ'
              }

              this.userEditData.loading = false;
            }
            
          } catch (error) {
            this.userEditData.response = {
              type: 'error',
              visible: true,
              text: '–ü—Ä–æ–∏–∑–æ—à–ª–æ –æ—à–∏–±–∫–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–∏–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π'
            }
            this.userEditData.loading = false;

          }
        },
        async onRemoveFromFav(id) {
          const indexOfArticle = this.$store.state.user.favArticles.findIndex(el => el.id === id);
          this.$store.state.user.favArticles[indexOfArticle].loading = true;
          try {
            const data = {
              id
            }
            const res = await req.post('favorites/delete', data);
            console.log(res.data);
            this.$store.state.user.favArticles = res.data;
            // this.$store.state.user.favArticles[indexOfArticle].loading = false;
          } catch (e) {
            console.log(e);
            this.$store.state.user.favArticles[indexOfArticle].loading = false;
          }
        },
        editPorfileDate(field, value) {
          let data = {
            verification: false,
            field: field,
            value: value,
            label: this.getFieldLabel(field),
            loading: false,
            response: {
              type: null,
              visible: false,
              text: '',
            }
          }
          if(field == 'email' || field == 'phone') {
            data.verification = true
          }

          this.userEditData = data;
          this.userEditModal = true;
          
        },
        clearSecurity() {
          this.securityData = {
            loading: false,
            validated: false,
            old_password: '',
            new_password: '',
            new_password_repeat: ''
          }
        },
        updateOption(key) {
          if(key == 'logout') {
            this.$store.commit('removeUser');
          }
        },
        userDataFormat(user) {
          let data = {};
          
          data.username = {
            value: user.username,
            icon: 'ph ph-identification-card',
            id: 'username',
            label: '–õ–æ–≥–∏–Ω',
            editable: false
          }
          data.email = {
            value: user.email,
            icon: 'ph ph-envelope',
            id: 'email',
            label: 'Email',
            editable: true
          }
          data.first_name = {
            value: user.first_name,
            icon: 'ph ph-user-list',
            id: 'first_name',
            label: '–ò–º—è',
            editable: true
          }
          data.last_name = {
            value: user.last_name,
            icon: 'ph ph-user-list',
            id: 'last_name',
            label: '–§–∞–º–∏–ª–∏—è',
            editable: true
          }
          data.phone = {
            value: phoneInput(user.phone),
            icon: 'ph ph-phone',
            id: 'phone',
            label: '–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞',
            editable: true
          }

          this.profileData = Object.entries(data)
        },
        showWelcome(val) {
          console.log(val);
          if(val.showModal === true) {
            const welcome = typeof Cookies.get('welcomeModal');
            if (welcome != 'string') {
              this.welcomeModal = true;
              this.startLottie()
            }
          }
        },
        startLottie() {
          lottie.loadAnimation({
            container: document.getElementById('surprise'), // Required
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: '/wp-content/plugins/tch-auth-module/res/animation_lmhvpemy.json', // Required
          })
        },
        closeWelcomeModal() {
          Cookies.set('welcomeModal', 'closed');
          this.welcomeModal = false;
        },
        compareDates(date) {
          const currentDate = dayjs().format('YYYY-MM-DD');
          const yesterDate = dayjs().subtract(1, 'day').format('YYYY-MM-DD');

          if(date == currentDate) {
            return '–°–µ–≥–æ–¥–Ω—è'
          }
          if(date == yesterDate) {
            return '–í—á–µ—Ä–∞'
          }

          return dayjs(date).format('d MMM YYYY')
        },
        showTime(time) {
          return dayjs(time).format('HH:mm')
        },
        openPost(link) {
          window.open(link, '_self');
        },
        closeUserEditModal() {
          this.userEditModal = false;
          this.userEditData = {
            verification: false,
            field: '',
            value: '',
            label: '',
            loading: false,
            response: {
              type: null,
              visible: false,
              text: '',
            }
          };
        },
        getFieldLabel(key) {
          switch (key) {
            case 'phone':
              return '–¢–µ–ª–µ—Ñ–æ–Ω';
            case 'email':
              return 'Email';
            case 'first_name':
              return '–ò–º—è';
            case 'last_name':
              return '–§–∞–º–∏–ª–∏—è';          
            default:
              break;
          }
        },
        onEnterPhone(val) {
          if (val == 8) {
            this.userEditData.value = phoneInput('7')
          } else {
            this.userEditData.value = phoneInput(val)
          }
        },
      }
    }

    const app = Vue.createApp(App)
    app.use(naive);
    app.use(store);
    app.mount('#account')
  });
</script>